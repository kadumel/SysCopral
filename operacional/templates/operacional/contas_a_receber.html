{% extends 'home.html' %}

{% block title %}Contas A Receber - Operacional{% endblock %}

{% block extra_css %}
<style>
	:root {
		--primary-color: #0056b3;
		--text-color: #333;
		--light-gray: #f8f9fa;
		--border-radius: 12px;
		--shadow-deep: 0 12px 24px -8px rgba(0, 0, 0, 0.18);
	}
	body { background-color: var(--light-gray); background-image: linear-gradient(135deg, rgba(0, 86, 179, 0.06), rgba(0, 51, 102, 0.06)); }
	.receber-main-content { padding: 1.25rem 1rem; min-height: 100vh; max-width: 100%; margin: 0 auto; }
	.header-filters { background: #fff; border-radius: var(--border-radius); padding: 1.5rem; box-shadow: var(--shadow-deep); margin-bottom: 1rem; position: relative; }
	.header-filters::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary-color); border-radius: var(--border-radius) var(--border-radius) 0 0; }
	.page-title { color: var(--primary-color); font-weight: 700; font-size: 1.75rem; margin-bottom: 1rem; display: flex; align-items: center; gap: .5rem; }
	.table-container { background: #fff; border-radius: var(--border-radius); box-shadow: var(--shadow-deep); overflow: hidden; }
	.table thead th { background: var(--primary-color); color: #fff; border: none; padding: 1rem; text-align: center; }
	.table { width: 100%; }
	.table tbody td { padding: 1rem; vertical-align: middle; text-align: center; border-bottom: 1px solid #e9ecef; }
	.form-control, .form-select { padding: .75rem; border: 2px solid #e9ecef; border-radius: 8px; }
	.form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 .2rem rgba(0, 86, 179, .15); }
	.table-responsive { width: 100%; }
	@media (min-width: 1200px) {
		.header-filters, .table-container { margin-left: 0; margin-right: 0; }
	}
</style>
{% endblock %}

{% block content %}
<div class="receber-main-content">
  <div class="header-filters">
    <h1 class="page-title"><i class="fas fa-hand-holding-usd"></i> Gestão de Contas a Receber</h1>
    <div class="text-muted">Cabeçalhos gerados a partir de Serviços Movimentados.</div>
    <div class="mt-2">
      <a href="{% url 'operacional:servicos_movimentos' %}" class="btn btn-secondary btn-sm">
        <i class="fas fa-wrench me-1"></i> Ir para Serviços
      </a>
    </div>
    <form method="get" class="mt-3">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Placa</label>
          <select name="placa" class="form-select">
            <option value="" {% if not placa_filtro %}selected{% endif %}>Todas</option>
            {% for p in placas_disponiveis %}
              <option value="{{ p }}" {% if placa_filtro == p %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
          <button class="btn btn-primary" type="submit"><i class="fas fa-search me-1"></i>Filtrar</button>
          <a class="btn btn-secondary" href="{% url 'operacional:contas_a_receber' %}"><i class="fas fa-times me-1"></i>Limpar</a>
        </div>
      </div>
    </form>
  </div>

  <div class="table-container">
    <div class="card-body">
    {% if contas %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Placa</th>
            <th>Data Fechamento</th>
            <th>Valor</th>
            <th>Qtde Itens</th>
            <th>Qtde Vencimentos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for c in contas %}
          <tr>
            <td class="text-start">{{ c.placa.placa.placa }}</td>
            <td>{{ c.data_fechamento|date:"d/m/Y" }}</td>
            <td>R$ {{ c.valor|floatformat:2 }}</td>
            <td>{{ c.qtd_itens }}</td>
            <td>{{ c.qtd_venc }}</td>
            <td>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm btn-car-itens" data-id="{{ c.id }}" title="Itens">
                  <i class="fas fa-list"></i>
                </button>
                <button type="button" class="btn btn-outline-success btn-sm btn-car-venc" data-id="{{ c.id }}" title="Vencimentos">
                  <i class="fas fa-calendar-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm btn-car-del" data-id="{{ c.id }}" title="{% if c.locked %}Bloqueado por fechamento{% else %}Excluir Contas a Receber{% endif %}" {% if c.locked %}disabled{% endif %}>
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-muted text-center py-4">
      <i class="fas fa-inbox fa-3x mb-2 d-block"></i>
      Nenhum contas a receber encontrado.
    </div>
    {% endif %}
  </div>
  </div>
</div>

<!-- Modal Itens -->
<div class="modal fade" id="modalCARItens" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Itens - Contas a Receber</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead id="carItensHead"></thead>
            <tbody id="carItensBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Vencimentos -->
<div class="modal fade" id="modalCARVenc" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vencimentos - Contas a Receber</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Data</th>
                <th>Fechamento ID</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="carVencBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('click', async function(e){
  // Itens
  const btnItens = e.target.closest('.btn-car-itens');
  if (btnItens){
    const id = btnItens.getAttribute('data-id');
    try{
      const resp = await fetch(`/operacional/contas-a-receber/${id}/itens/`);
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao carregar itens'); return; }
      const rows = data.rows||[];
      const thead = document.getElementById('carItensHead');
      const tbody = document.getElementById('carItensBody');
      const canDelete = !!data.can_delete;
      if (!rows.length){
        thead.innerHTML = '<tr><th>Mensagem</th><th>Ações</th></tr>';
        tbody.innerHTML = '<tr><td class="text-muted">Sem itens</td><td></td></tr>';
      }else{
        const cols = Object.keys(rows[0]).filter(c=>c!=='id');
        thead.innerHTML = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'<th>Ações</th></tr>';
        tbody.innerHTML = rows.map(r=>{
          const tds = cols.map(c=>`<td>${r[c]??''}</td>`).join('');
          const btn = `<button type="button" class="btn btn-outline-danger btn-sm btn-car-item-del" data-id="${r.id}" ${canDelete?'':'disabled title="Bloqueado por fechamento"'}><i class="fas fa-trash"></i></button>`;
          return `<tr>${tds}<td class="text-center">${btn}</td></tr>`;
        }).join('');
      }
      const el = document.getElementById('modalCARItens');
      el.dataset.crId = id;
      const m = (typeof bootstrap!=='undefined') ? bootstrap.Modal.getOrCreateInstance(el) : null;
      if (m) m.show(); else el.style.display='block';
    }catch(err){ console.error(err); alert('Erro ao carregar itens'); }
    return;
  }
  // Vencimentos
  const btnVenc = e.target.closest('.btn-car-venc');
  if (btnVenc){
    const id = btnVenc.getAttribute('data-id');
    try{
      const resp = await fetch(`/operacional/contas-a-receber/${id}/vencimentos/`);
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao carregar vencimentos'); return; }
      const rows = data.rows||[];
      const tb = document.getElementById('carVencBody');
      if (!rows.length){
        tb.innerHTML = '<tr><td class="text-muted" colspan="4">Sem vencimentos</td></tr>';
      }else{
        tb.innerHTML = rows.map(r=>`<tr><td>${r.seq}</td><td>${r.data}</td><td>${r.fechamento_id ?? ''}</td><td>R$ ${Number(r.valor||0).toFixed(2)}</td></tr>`).join('');
      }
      const el = document.getElementById('modalCARVenc');
      const m = (typeof bootstrap!=='undefined') ? bootstrap.Modal.getOrCreateInstance(el) : null;
      if (m) m.show(); else el.style.display='block';
    }catch(err){ console.error(err); alert('Erro ao carregar vencimentos'); }
    return;
  }
  // Excluir Contas a Receber (cabeçalho)
  const btnDel = e.target.closest('.btn-car-del');
  if (btnDel){
    const id = btnDel.getAttribute('data-id');
    if (!id) return;
    if (!confirm('Confirma excluir este Contas a Receber, seus itens e vencimentos?')) return;
    try{
      const resp = await fetch(`/operacional/contas-a-receber/${id}/excluir/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao excluir'); return; }
      location.reload();
    }catch(err){ console.error(err); alert('Erro ao excluir'); }
    return;
  }
  // Excluir item
  const btnItemDel = e.target.closest('.btn-car-item-del');
  if (btnItemDel){
    const id = btnItemDel.getAttribute('data-id');
    if (!id) return;
    if (!confirm('Confirma excluir este item do Contas a Receber?')) return;
    try{
      const resp = await fetch(`/operacional/contas-a-receber/itens/${id}/excluir/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao excluir item'); return; }
      // Atualizar a linha do cabeçalho na tabela principal (valor, quantidades)
      try {
        const crId = data.cr_id || (document.getElementById('modalCARItens')?.dataset?.crId);
        if (crId){
          const headerBtn = document.querySelector(`.btn-car-itens[data-id="${crId}"]`);
          const row = headerBtn ? headerBtn.closest('tr') : null;
          if (row){
            // colunas: 0=Placa,1=Data,2=Valor,3=Qtde Itens,4=Qtde Venc,5=Ações
            const tds = row.querySelectorAll('td');
            const fmtMoney = (v) => {
              const n = Number(v||0);
              // Formatar como 'R$ 0,00' com vírgula decimal
              return 'R$ ' + n.toFixed(2).replace('.', ',');
            };
            if (tds[2]) tds[2].textContent = fmtMoney(data.total_cab);
            if (tds[3]) tds[3].textContent = (data.qtd_itens ?? '').toString();
            if (tds[4]) tds[4].textContent = (data.qtd_venc ?? '').toString();
          }
        }
      } catch(_e){}
      // Recarregar itens do CR atual sem fechar o modal
      const el = document.getElementById('modalCARItens');
      const crId = el?.dataset?.crId;
      if (crId){
        const r = await fetch(`/operacional/contas-a-receber/${crId}/itens/`);
        const j = await r.json();
        if (!r.ok || !j.success){ alert(j.error||'Falha ao recarregar itens'); return; }
        const rows = j.rows||[];
        const canDelete = !!j.can_delete;
        const thead = document.getElementById('carItensHead');
        const tbody = document.getElementById('carItensBody');
        if (!rows.length){
          thead.innerHTML = '<tr><th>Mensagem</th><th>Ações</th></tr>';
          tbody.innerHTML = '<tr><td class="text-muted">Sem itens</td><td></td></tr>';
        }else{
          const cols = Object.keys(rows[0]).filter(c=>c!=='id');
          thead.innerHTML = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'<th>Ações</th></tr>';
          tbody.innerHTML = rows.map(rw=>{
            const tds = cols.map(c=>`<td>${rw[c]??''}</td>`).join('');
            const btn = `<button type="button" class="btn btn-outline-danger btn-sm btn-car-item-del" data-id="${rw.id}" ${canDelete?'':'disabled title="Bloqueado por fechamento"'}><i class="fas fa-trash"></i></button>`;
            return `<tr>${tds}<td class="text-center">${btn}</td></tr>`;
          }).join('');
        }
      }else{
        location.reload();
      }
    }catch(err){ console.error(err); alert('Erro ao excluir item'); }
  }
});
</script>
{% endblock %}


