{% extends 'home.html' %}

{% block title %}Contas A Receber - Operacional{% endblock %}

{% block content %}
<div class="content-header">
    <h1>Gestão de Contas a Receber</h1>
    <div class="text-muted">Cabeçalhos gerados a partir de Serviços Movimentados.</div>
    <div class="mt-2">
        <a href="{% url 'operacional:servicos_movimentos' %}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-wrench me-1"></i> Ir para Serviços
        </a>
    </div>
  </div>

<form method="get" class="row g-3 mt-2">
  <div class="col-md-3">
    <label class="form-label">Placa</label>
    <select name="placa" class="form-select">
      <option value="" {% if not placa_filtro %}selected{% endif %}>Todas</option>
      {% for p in placas_disponiveis %}
        <option value="{{ p }}" {% if placa_filtro == p %}selected{% endif %}>{{ p }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Data Início</label>
    <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Data Fim</label>
    <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
  </div>
  <div class="col-md-3 d-flex align-items-end gap-2">
    <button class="btn btn-primary" type="submit"><i class="fas fa-search me-1"></i>Filtrar</button>
    <a class="btn btn-secondary" href="{% url 'operacional:contas_a_receber' %}"><i class="fas fa-times me-1"></i>Limpar</a>
  </div>
</form>

<div class="card mt-3">
  <div class="card-body">
    {% if contas %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Placa</th>
            <th>Data Fechamento</th>
            <th>Valor</th>
            <th>Qtde Itens</th>
            <th>Qtde Vencimentos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for c in contas %}
          <tr>
            <td class="text-start">{{ c.placa.placa.placa }}</td>
            <td>{{ c.data_fechamento|date:"d/m/Y" }}</td>
            <td>R$ {{ c.valor|floatformat:2 }}</td>
            <td>{{ c.qtd_itens }}</td>
            <td>{{ c.qtd_venc }}</td>
            <td>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm btn-car-itens" data-id="{{ c.id }}" title="Itens">
                  <i class="fas fa-list"></i>
                </button>
                <button type="button" class="btn btn-outline-success btn-sm btn-car-venc" data-id="{{ c.id }}" title="Vencimentos">
                  <i class="fas fa-calendar-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm btn-car-del" data-id="{{ c.id }}" title="{% if c.locked %}Bloqueado por fechamento{% else %}Excluir Contas a Receber{% endif %}" {% if c.locked %}disabled{% endif %}>
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-muted">Nenhum contas a receber encontrado.</div>
    {% endif %}
  </div>
</div>

<!-- Modal Itens -->
<div class="modal fade" id="modalCARItens" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Itens - Contas a Receber</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead id="carItensHead"></thead>
            <tbody id="carItensBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Vencimentos -->
<div class="modal fade" id="modalCARVenc" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vencimentos - Contas a Receber</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Data</th>
                <th>Fechamento ID</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="carVencBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('click', async function(e){
  // Itens
  const btnItens = e.target.closest('.btn-car-itens');
  if (btnItens){
    const id = btnItens.getAttribute('data-id');
    try{
      const resp = await fetch(`/operacional/contas-a-receber/${id}/itens/`);
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao carregar itens'); return; }
      const rows = data.rows||[];
      const thead = document.getElementById('carItensHead');
      const tbody = document.getElementById('carItensBody');
      const canDelete = !!data.can_delete;
      if (!rows.length){
        thead.innerHTML = '<tr><th>Mensagem</th><th>Ações</th></tr>';
        tbody.innerHTML = '<tr><td class="text-muted">Sem itens</td><td></td></tr>';
      }else{
        const cols = Object.keys(rows[0]).filter(c=>c!=='id');
        thead.innerHTML = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'<th>Ações</th></tr>';
        tbody.innerHTML = rows.map(r=>{
          const tds = cols.map(c=>`<td>${r[c]??''}</td>`).join('');
          const btn = `<button type="button" class="btn btn-outline-danger btn-sm btn-car-item-del" data-id="${r.id}" ${canDelete?'':'disabled title="Bloqueado por fechamento"'}><i class="fas fa-trash"></i></button>`;
          return `<tr>${tds}<td class="text-center">${btn}</td></tr>`;
        }).join('');
      }
      const el = document.getElementById('modalCARItens');
      el.dataset.crId = id;
      const m = (typeof bootstrap!=='undefined') ? bootstrap.Modal.getOrCreateInstance(el) : null;
      if (m) m.show(); else el.style.display='block';
    }catch(err){ console.error(err); alert('Erro ao carregar itens'); }
    return;
  }
  // Vencimentos
  const btnVenc = e.target.closest('.btn-car-venc');
  if (btnVenc){
    const id = btnVenc.getAttribute('data-id');
    try{
      const resp = await fetch(`/operacional/contas-a-receber/${id}/vencimentos/`);
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao carregar vencimentos'); return; }
      const rows = data.rows||[];
      const tb = document.getElementById('carVencBody');
      if (!rows.length){
        tb.innerHTML = '<tr><td class="text-muted" colspan="4">Sem vencimentos</td></tr>';
      }else{
        tb.innerHTML = rows.map(r=>`<tr><td>${r.seq}</td><td>${r.data}</td><td>${r.fechamento_id ?? ''}</td><td>R$ ${Number(r.valor||0).toFixed(2)}</td></tr>`).join('');
      }
      const el = document.getElementById('modalCARVenc');
      const m = (typeof bootstrap!=='undefined') ? bootstrap.Modal.getOrCreateInstance(el) : null;
      if (m) m.show(); else el.style.display='block';
    }catch(err){ console.error(err); alert('Erro ao carregar vencimentos'); }
    return;
  }
  // Excluir Contas a Receber (cabeçalho)
  const btnDel = e.target.closest('.btn-car-del');
  if (btnDel){
    const id = btnDel.getAttribute('data-id');
    if (!id) return;
    if (!confirm('Confirma excluir este Contas a Receber, seus itens e vencimentos?')) return;
    try{
      const resp = await fetch(`/operacional/contas-a-receber/${id}/excluir/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao excluir'); return; }
      location.reload();
    }catch(err){ console.error(err); alert('Erro ao excluir'); }
    return;
  }
  // Excluir item
  const btnItemDel = e.target.closest('.btn-car-item-del');
  if (btnItemDel){
    const id = btnItemDel.getAttribute('data-id');
    if (!id) return;
    if (!confirm('Confirma excluir este item do Contas a Receber?')) return;
    try{
      const resp = await fetch(`/operacional/contas-a-receber/itens/${id}/excluir/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      const data = await resp.json();
      if (!resp.ok || !data.success){ alert(data.error||'Falha ao excluir item'); return; }
      // Recarregar itens do CR atual sem fechar o modal
      const el = document.getElementById('modalCARItens');
      const crId = el?.dataset?.crId;
      if (crId){
        const r = await fetch(`/operacional/contas-a-receber/${crId}/itens/`);
        const j = await r.json();
        if (!r.ok || !j.success){ alert(j.error||'Falha ao recarregar itens'); return; }
        const rows = j.rows||[];
        const canDelete = !!j.can_delete;
        const thead = document.getElementById('carItensHead');
        const tbody = document.getElementById('carItensBody');
        if (!rows.length){
          thead.innerHTML = '<tr><th>Mensagem</th><th>Ações</th></tr>';
          tbody.innerHTML = '<tr><td class="text-muted">Sem itens</td><td></td></tr>';
        }else{
          const cols = Object.keys(rows[0]).filter(c=>c!=='id');
          thead.innerHTML = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'<th>Ações</th></tr>';
          tbody.innerHTML = rows.map(rw=>{
            const tds = cols.map(c=>`<td>${rw[c]??''}</td>`).join('');
            const btn = `<button type="button" class="btn btn-outline-danger btn-sm btn-car-item-del" data-id="${rw.id}" ${canDelete?'':'disabled title="Bloqueado por fechamento"'}><i class="fas fa-trash"></i></button>`;
            return `<tr>${tds}<td class="text-center">${btn}</td></tr>`;
          }).join('');
        }
      }else{
        location.reload();
      }
    }catch(err){ console.error(err); alert('Erro ao excluir item'); }
  }
});
</script>
{% endblock %}


